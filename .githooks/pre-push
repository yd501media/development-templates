#!/bin/sh
set -eu

while read -r _local_ref _local_sha _remote_ref _remote_sha; do
  if [ "$_remote_ref" = "refs/heads/main" ] || [ "$_local_ref" = "refs/heads/main" ]; then
    echo "Error: direct pushes to 'main' are blocked. Use a PR workflow." >&2
    exit 1
  fi
done

# Run minimal lint/test/build checks when available.
ran_checks=0
if [ -f "Makefile" ]; then
  echo "Running make format-check..."
  if make -n format-check >/dev/null 2>&1; then
    make format-check
  elif make -n format:check >/dev/null 2>&1; then
    make format:check
  else
    echo "No 'format-check' or 'format:check' target found in Makefile; skipping format check." >&2
  fi

  echo "Running make lint..."
  if make -n lint >/dev/null 2>&1; then
    make lint
  else
    echo "No 'lint' target found in Makefile; skipping."
  fi

  echo "Running make test..."
  if make -n test >/dev/null 2>&1; then
    make test
  else
    echo "No 'test' target found in Makefile; skipping."
  fi

  echo "Running make build..."
  if make -n build >/dev/null 2>&1; then
    make build
  else
    echo "No 'build' target found in Makefile; skipping." >&2
  fi
  ran_checks=1
fi

if [ -f "package.json" ]; then
  if [ -d "node_modules" ]; then
    echo "Skipping 'npm install'; node_modules already exists."
  else
    echo "Installing npm dependencies (node_modules not found)..."
    npm install
  fi

  if node -e "process.exit((require('./package.json').scripts || {})['format:check'] ? 0 : 1)"; then
    echo "Running npm run format:check..."
    npm run -s format:check
  elif node -e "process.exit((require('./package.json').scripts || {})['fmt:check'] ? 0 : 1)"; then
    echo "Running npm run fmt:check..."
    npm run -s fmt:check
  else
    echo "No format:check script; skipping."
  fi

  if node -e "process.exit((require('./package.json').scripts || {}).lint ? 0 : 1)"; then
    echo "Running npm run lint..."
    npm run -s lint
  else
    echo "No lint script; skipping."
  fi

  echo "Running npm test..."
  npm test --silent --if-present

  if node -e "process.exit((require('./package.json').scripts || {}).build ? 0 : 1)"; then
    echo "Running npm run build..."
    npm run -s build
  else
    echo "No build script; skipping."
  fi
  ran_checks=1
fi

if [ -f "pyproject.toml" ] || [ -f "requirements.txt" ]; then
  echo "Python project detected. Customize pre-push to your tooling (ruff/black/pytest/etc.)." >&2
  ran_checks=1
fi

if [ -f "go.mod" ]; then
  echo "Running go test ./..."
  go test ./...
  ran_checks=1
fi

if [ "$ran_checks" -eq 0 ]; then
  echo "No lint/test hooks configured for this repository; skipping." >&2
fi
exit 0
