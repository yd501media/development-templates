#!/bin/sh
set -eu

branch="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo '')"
if [ "$branch" = "main" ]; then
  echo "Error: direct commits to 'main' are blocked. Use a feature branch and open a PR." >&2
  exit 1
fi

# Block accidental commits of dependencies, secrets, or build outputs.
forbidden_paths='(^|/)(node_modules/|dist/|build/|coverage/|\.env($|/))'
staged_files="$(git diff --cached --name-only --diff-filter=ACMR 2>/dev/null || true)"
if printf '%s\n' "$staged_files" | grep -E -q "$forbidden_paths"; then
  echo "Error: staged files include dependencies, secrets, or build outputs (e.g., node_modules, .env, dist)." >&2
  exit 1
fi

# Block large files (>5MB) from being committed.
max_bytes=$((5 * 1024 * 1024))
if [ -n "$staged_files" ]; then
  printf '%s\n' "$staged_files" | while IFS= read -r path; do
    object_id="$(git rev-parse --verify ":$path" 2>/dev/null || true)"
    if [ -n "$object_id" ]; then
      size="$(git cat-file -s "$object_id" 2>/dev/null || echo 0)"
      if [ "$size" -gt "$max_bytes" ]; then
        echo "Error: '$path' is larger than 5MB; use Git LFS or reduce file size." >&2
        exit 1
      fi
    fi
  done
fi

# Scan staged changes for secrets before each commit.
if command -v gitleaks >/dev/null 2>&1; then
  git diff --cached -U0 --no-color | gitleaks detect --pipe --redact
else
  echo "Error: gitleaks is required. Install with 'brew install gitleaks'." >&2
  exit 1
fi
