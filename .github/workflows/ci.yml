name: CI

on:
  pull_request:
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Node version (optional)
        id: nodever
        shell: bash
        run: |
          set -euo pipefail
          if [[ -f ".nvmrc" ]]; then
            echo "version=$(cat .nvmrc)" >> "$GITHUB_OUTPUT"
          elif [[ -f ".node-version" ]]; then
            echo "version=$(cat .node-version)" >> "$GITHUB_OUTPUT"
          else
            echo "version=lts/*" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node (if package.json exists)
        if: ${{ hashFiles('package.json') != '' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ steps.nodever.outputs.version }}
          cache: npm

      - name: Run format/lint/test/build (stack-agnostic)
        shell: bash
        run: |
          set -euo pipefail

          echo "Running repository checks per AGENTS.md expectations."
          echo "Customize commands for your stack as needed."

          # Prefer Makefile targets if present.
          if [[ -f "Makefile" ]]; then
            echo "::group::make format:check"
            if make -n format-check >/dev/null 2>&1; then
              make format-check
            elif make -n format:check >/dev/null 2>&1; then
              make format:check
            else
              echo "No 'format-check' or 'format:check' target found in Makefile; failing CI."
              exit 1
            fi
            echo "::endgroup::"

            echo "::group::make lint"
            make lint
            echo "::endgroup::"

            echo "::group::make test"
            make test
            echo "::endgroup::"

            echo "::group::make build"
            make build
            echo "::endgroup::"
            exit 0
          fi

          # Node.js projects
          if [[ -f "package.json" ]]; then
            echo "::group::npm ci"
            npm ci
            echo "::endgroup::"

            # Common script names; skip gracefully if missing.
            echo "::group::format check"
            if node -e "process.exit((require('./package.json').scripts || {})['format:check'] ? 0 : 1)"; then
              npm run -s format:check
            elif node -e "process.exit((require('./package.json').scripts || {})['fmt:check'] ? 0 : 1)"; then
              npm run -s fmt:check
            else
              echo "No format:check script; skipping"
            fi
            echo "::endgroup::"

            echo "::group::lint"
            if node -e "process.exit((require('./package.json').scripts || {}).lint ? 0 : 1)"; then
              npm run -s lint
            else
              echo "No lint script; skipping"
            fi
            echo "::endgroup::"

            echo "::group::test"
            npm test --silent --if-present
            echo "::endgroup::"

            echo "::group::build"
            if node -e "process.exit((require('./package.json').scripts || {}).build ? 0 : 1)"; then
              npm run -s build
            else
              echo "No build script; skipping"
            fi
            echo "::endgroup::"

            exit 0
          fi

          # Python projects (basic)
          if [[ -f "pyproject.toml" ]] || [[ -f "requirements.txt" ]]; then
          echo "::warning::Python project detected. Please customize CI to your tooling (ruff/black/pytest/etc.)."
          exit 0
          fi

          # Go projects (basic)
          if [[ -f "go.mod" ]]; then
            echo "::group::go test"
            go test ./...
            echo "::endgroup::"
            exit 0
          fi

          echo "::warning::No known project type detected. Skipping CI checks. Please customize .github/workflows/ci.yml for this repository."
          exit 0
